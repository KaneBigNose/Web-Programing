<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>KakaoMap API Example</title>
    <style>
        #map {
            width: 100%;
            height: 400px;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script type="text/javascript"
        src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=ab20dd7e58d76f56e7c1af0c3c89152b&libraries=services,clusterer,drawing"></script>
    <script>
        var mapContainer = document.getElementById('map');
        var mapOption = {
            center: new kakao.maps.LatLng(35.145281, 129.071390),
            level: 3
        };

        var map = new kakao.maps.Map(mapContainer, mapOption);

        var geocoder = new kakao.maps.services.Geocoder();

        var startPoint;
        var endPoint;

        geocoder.addressSearch('부산 남구 수영로 237', function (startResult, status) {
            if (status === kakao.maps.services.Status.OK) {
                startPoint = new kakao.maps.LatLng(startResult[0].y, startResult[0].x);

                geocoder.addressSearch('부산 남구 못골번영로 105', function (endResult, status) {
                    if (status === kakao.maps.services.Status.OK) {
                        endPoint = new kakao.maps.LatLng(endResult[0].y, endResult[0].x);
                        
                        getCarDirection(startPoint, endPoint);  // 여기에서 함수 호출
                    }
                });
            }
        });

        async function getCarDirection(startPoint, endPoint) {
            const REST_API_KEY = 'c9d2b78d34fbc3df0704bfa5d62a723a';

            const url = 'https://apis-navi.kakaomobility.com/v1/directions';

            const origin = `${startPoint.getLng()},${startPoint.getLat()}`;
            const destination = `${endPoint.getLng()},${endPoint.getLat()}`;

            const headers = {
                Authorization: `KakaoAK ${REST_API_KEY}`,
                'Content-Type': 'application/json'
            };

            const queryParams = new URLSearchParams({
                origin: origin,
                destination: destination
            });

            const requestUrl = `${url}?${queryParams}`;

            try {
                const response = await fetch(requestUrl, {
                    method: 'GET',
                    headers: headers
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();

                const linePath = [];
                data.routes[0].sections[0].roads.forEach(router => {
                    router.vertexes.forEach((vertex, index) => {
                        if (index % 2 === 0) {
                            linePath.push(new kakao.maps.LatLng(router.vertexes[index + 1], router.vertexes[index]));
                        }
                    });
                });
                var polyline = new kakao.maps.Polyline({
                    path: linePath,
                    strokeWeight: 5,
                    strokeColor: '#000000',
                    strokeOpacity: 0.7,
                    strokeStyle: 'solid'
                });
                polyline.setMap(map);

            } catch (error) {
                console.error('Error:', error);
            }
        }
    </script>
</body>

</html>
